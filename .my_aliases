#!/usr/local/bin/bash

alias rg="rg --pretty --glob '!tags' --max-columns 300 "
alias rgi="rg --pretty --ignore-case --glob '!tags' --max-columns 300 "

# -r recursive, -n line number -i case insensitive, -s no messages, -I ignore binary, -S follow symlinks
# -o matching only, -h no filename
alias g="egrep -rnisIS --color"
alias gc="egrep -rnsIS --color"

alias l="gls -l -h --color --group-directories-first  --dereference-command-line-symlink-to-dir --dereference-command-line --dereference"
alias ls="gls -h --color --group-directories-first  --dereference-command-line-symlink-to-dir --dereference-command-line --dereference"

export FZF_DEFAULT_COMMAND='rg --files --no-ignore --hidden --follow --glob "!{.git}" 2> /dev/null'
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
bind -x '"\C-p": fzf_result=$(fzf); [[ ! -z $fzf_result ]] && vim $fzf_result'

parse_git_branch() {
    branch=$(git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/(\1)/')
    echo "" ${branch}
}

auto_virtualenv() {
    command=$(python3 ~/auto-virtualenv/venv_toggle_command.py --command)
    eval $command
}

virtualenv_info() {
    project_name=$(python3 ~/auto-virtualenv/venv_toggle_command.py --project-name)
    if [[ -n $project_name ]]; then
        echo "($project_name) "
    fi
}

function timer_start {
    timer=${timer:-$SECONDS}
}

function timer_stop {
    # echo "${SECONDS} | ${timer}"
    timer_show=$(($SECONDS - $timer))
    # unset timer
}

# trap 'timer_start' DEBUG

prompt_command() {
	# timer_stop
	auto_virtualenv
}

export PROMPT_COMMAND=prompt_command

make_ps1() {
    # 256 colour example thing="\[\033[0;38;5;TWO_FIVE_SIZEm\][test]\[\033[0m\] "
    # rgb colour example thing="\[\033[0;38;2;R;G;Bm\][test]\[\033[0m\] "

    newline="\n"
    host="\[\033[1;30m\][PINS]\[\033[0m\] "
    # duration="\[\033[1;4;30m\]\${timer_show}s\[\033[0m\] "
    virtualenv="\[\033[1;32m\]\$(virtualenv_info)\[\033[0m\]"
    working_path="\[\033[1;36m\]\w\[\033[0m\]"
    git="\[\033[1;31m\]\$(parse_git_branch)\[\033[0m\]"
    arrow="\[\033[0;34m\]\n~>\[\033[0m\] "
    echo "${newline}${host}${duration}${virtualenv}${working_path}${git}${arrow}"
}

[ -f /opt/homebrew/etc/bash_completion.d/git-completion.bash ] && . /opt/homebrew/etc/bash_completion.d/git-completion.bash

PROMPT_DIRTRIM=5
export VIRTUAL_ENV_DISABLE_PROMPT=1
export PS1=$(make_ps1);
export HASTE_SERVER="https://paste.pinadmin.com/"
export HASTE_SHARE_SERVER="https://paste.pinadmin.com/"
alias haste="haste | sed 's/share\///g'"
alias mgit='GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa_personal_github_real.pub" git'
